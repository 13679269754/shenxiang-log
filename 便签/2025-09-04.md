2025-09-04
## mysql 8.0.34 版本几个文件

/usr/local/data/mysql_data/db3306/auto.cnf  保存server_uuid


innodb_cluster
## 8.8.3 从重大故障中重启集群
dba.rebootClusterFromCompleteOutage("【cluster_name】",{【primary: "127.0.0.1:4001",force:true,dryRun: true】})

dryRun : 您可以通过使用 `dryRun` 选项来测试更改

### 8.8.4 重新扫描集群
_`Cluster`_.rescan()
### 8.8.5 集群隔离
`<Cluster>.fenceWrites()` : 停止对 ClusterSet 主集群的写流量。
`<Cluster>.unfenceWrites()` : 恢复写入流量。
`<Cluster>.fenceAllTraffic()` ：从所有流量中隔离一个集群。
### 8.5.1 设置 InnoDB 集群选项

innodb 集群选项

-- 全局
_`Cluster`_.setOption(_`option`_, _`value`_) 

-- 针对节点
_`Cluster`_.setInstanceOption(instance, _`option`_, _`value`_)

### 8.5.3 配置选举过程（权重）

```json
dba.createCluster('cluster1', {memberWeight:35}) 
var mycluster = dba.getCluster() 
mycluster.addInstance('icadmin@ic2', {memberWeight:25}) mycluster.addInstance('icadmin@ic3', {memberWeight:50})
```


### 8.5.4 配置故障转移一致性

**group_replication_consistency** 取值以及意义。

| 取值                           | 核心行为          | 一致性强度 | 性能影响 | 典型场景          |
| ---------------------------- | ------------- | ----- | ---- | ------------- |
| `EVENTUAL`                   | 异步同步，最终一致     | 低     | 小    | 大多数常规业务       |
| `BEFORE_ON_PRIMARY_FAILOVER` | 故障切换后保证一致性    | 中     | 中    | 主从切换场景        |
| `BEFORE`                     | 事务执行前等待前置事务同步 | 中高    | 中    | 高读取一致性需求      |
| `AFTER`                      | 事务提交后等待全节点同步  | 高     | 大    | 高写后读一致性需求     |
| `BEFORE_AND_AFTER`           | 执行前+提交后双重同步   | 最高    | 最大   | 核心金融交易等强一致性场景 |


### mysql 1. 两种通信栈的区别


group_replication_communication_stack 

| **维度**   | **XCOM 通信栈**                                                  | **MYSQL 通信栈**(默认值)                                 |
| -------- | ------------------------------------------------------------- | -------------------------------------------------- |
| **实现方式** | 基于 Paxos 协议的独立通信层，专为组复制设计                                     | 复用 MySQL 服务器的原生网络栈（基于 TCP/IP），与 MySQL 服务共享网络配置     |
| **端口配置** | 需要显式指定 `group_replication_local_address`（如 `ip:33061`），使用独立端口 | 自动复用 MySQL 服务的网络地址（如 `bind-address`），无需额外端口配置      |
| **兼容性**  | 支持 MySQL 5.7 及以上版本（早期默认值）                                     | 仅支持 MySQL 8.0.16 及以上版本（8.0.27 后成为默认值）              |
| **加密机制** | 需单独配置 TLS 加密（通过 `group_replication_tls_*` 参数）                 | 直接复用 MySQL 服务的 TLS 配置（如 `ssl_ca`、`ssl_cert` 等全局变量） |
| **网络依赖** | 独立于 MySQL 服务的网络配置，可能受额外防火墙规则限制                                | 与 MySQL 服务共享网络配置，防火墙规则更统一                          |
| **性能特性** | 在高并发、跨节点事务同步场景下，延迟控制更稳定                                       | 网络层与 MySQL 服务共享，资源调度更高效，低负载场景下性能略优                 |

创建 innodb Cluster 指定通信栈
dba.createCluster("testCluster", {communicationStack: "mysql"})

### 8.5.6 配置并行复制应用器

| 参数名称                                     | 核心作用                              | 可选值                | 含义说明                                             |
| ---------------------------------------- | --------------------------------- | ------------------ | ------------------------------------------------ |
| `slave_preserve_commit_order`            | 控制从库并行事务的提交顺序，保证与主库一致性            | `ON`               | 从库事务必须严格按主库提交顺序提交，即使提前执行完也会等待前置事务，确保顺序一致         |
|                                          |                                   | `OFF`（默认）          | 从库事务执行完毕后立即提交，不保证与主库提交顺序一致（最终数据一致，但可见性顺序可能不同）    |
| `slave_parallel_type`                    | 定义从库并行复制的线程分配策略，决定事务是否可并行应用       | `DATABASE`（默认）     | 按数据库（Schema）划分并行性，不同库的事务可并行，同一库事务串行              |
|                                          |                                   | `LOGICAL_CLOCK`    | 基于事务依赖关系（逻辑时钟）划分并行性，主库记录事务依赖信息，从库对无依赖的事务并行应用     |
| `binlog_transaction_dependency_tracking` | 主库生成 binlog 时跟踪事务依赖关系，为从库并行复制提供依据 | `COMMIT_ORDER`（默认） | 基于事务提交顺序记录依赖，后提交的事务依赖于先提交的事务，可能过度标记依赖            |
|                                          |                                   | `WRITESET`         | 基于事务修改的数据集（WriteSet）判断依赖，无冲突的事务标记为可并行，提升并行度      |
|                                          |                                   | `WRITESET_SESSION` | 在 `WRITESET` 基础上，同一会话内事务强制串行（即使无冲突），避免会话内逻辑依赖被打破 |
