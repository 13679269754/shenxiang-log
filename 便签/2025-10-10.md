2025-10-10
## mysql readview 与mvcc 机制


[[mysql mvcc 小计]]

## 死锁检测

5.7 优化了死锁检测，采用wait-for-graph 锁等待图来检测是否死锁。
死锁检测参数
innodb_deadlock_detect 是否开启，一般都应该开启

[[对于购物车减库存如何做到高并发不发生，少发生锁等待呢]]

唯一索引引起的死锁
[[分析MySQL unique key check问题(插入意向锁导致的gap锁)]]

插入锁判断步骤
![[Pasted image 20251011155138.png]]
1. 找到插入的数据的后一条记录（next_rec）
2. 判断此记录上是否有锁gap锁
3. 当插入记录上有唯一索引，如果next_rec的pre_rec没有被锁住，判断pre_rec是否等于要插入的数据 （唯一性校验）
4. 如果pre_rec被锁住，则先获取一个s锁。