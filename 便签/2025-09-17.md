2025-09-17
## checkpoint

### 1.LSN
InnoDB 中涉及 6 个核心 LSN，分别对应日志生成、缓冲、写入、刷盘及数据页刷盘的全流程：

| LSN 名称                                | 含义                                                 | 何时发生变化                                                             |
| ------------------------------------- | -------------------------------------------------- | ------------------------------------------------------------------ |
| 1. `Log Sequence Number`（LSN_current） | 当前已生成的重做日志的最大序号（InnoDB 内部最新日志位置）。                  | 每次生成新的重做日志（如事务执行 `INSERT`/`UPDATE` 等操作）时，自动递增（增加量等于日志大小）。          |
| 2. `Log Buffer Assigned Up To`        | 日志缓冲区（Redo Log Buffer）中已分配空间的最大 LSN（为日志预留的内存空间上限）。 | 当日志缓冲区需要为新日志分配空间时更新，通常与 `LSN_current` 同步增长。                        |
| 3. `Log Buffer Completed Up To`       | 日志缓冲区中已**实际写入**的最大 LSN（已写入缓冲区但未刷到磁盘的日志）。           | 新日志写入缓冲区时更新（如事务执行过程中，日志先写入缓冲区）。                                    |
| 4. `Log Written Up To`                | 已从日志缓冲区写入到**磁盘日志文件**（如 `ib_logfile0`）的最大 LSN。      | 当日志缓冲区中的日志被刷新到磁盘日志文件时更新（受 `innodb_flush_log_at_trx_commit` 等参数控制）。 |
| 5. `Log Flushed Up To`                | 已通过 `fsync` 等操作确保**物理落盘**的最大 LSN（真正持久化到磁盘）。        | 当操作系统将日志文件从缓存刷到物理磁盘时更新（保证断电不丢失）。                                   |
| 6. `Last Checkpoint At`               | 最后一次检查点的 LSN（标记已确保数据一致性的日志位置，用于崩溃恢复）。              | 定期或触发检查点时更新（如日志文件快写满、脏页刷盘时），通常不超过 `Log Flushed Up To`。             |

### 2.CHECKPOINT
InnoDB 根据不同场景触发不同类型的 Checkpoint，确保效率与安全性平衡：

| Checkpoint 类型             | 触发时机                                   | 主要操作                                                 |
| ------------------------- | -------------------------------------- | ---------------------------------------------------- |
| **Sharp Checkpoint**      | 数据库正常关闭（`SHUTDOWN`）                    | 刷写所有脏页到磁盘，更新 Checkpoint LSN 为最新日志位置（确保关闭时数据完全一致）。    |
| **Fuzzy Checkpoint**      | 日常运行中（最常见）                             | 只刷写部分脏页（如缓冲池空间不足、日志文件快写满时），不阻塞正常事务，是“模糊”的部分同步。       |
| **Async/Sync Checkpoint** | 后台线程定期触发（如 `srv_master_thread`）        | 异步/同步刷写脏页（`Async` 不阻塞用户线程，`Sync` 可能短暂阻塞），平衡内存与磁盘一致性。 |
| **Force Checkpoint**      | 手动执行 `FLUSH TABLES WITH READ LOCK` 等命令 | 强制触发脏页刷盘，用于备份或维护场景（确保备份时数据文件与日志状态一致）。                |

-- 2025-09-25 补充

“Checkpoint 的 LSN 到 60000000，那么 redo log 中到 60000000 的所有事务修改的数据页都会触发落盘”—— 这个说法的**核心逻辑正确**（这些数据页确实会被触发刷盘），但需补充两点：

1. 这些数据页是**异步、分批刷盘**，而非一次性强制落盘；
2. Checkpoint LSN 推进时，可能有部分数据页尚未完成刷盘，但系统会保证它们最终会被刷盘（否则 Checkpoint LSN 不会真正推进）。


## flush list 刷新相关参数
```sql
mysql> show variables like '%lru%';
+-----------------------+-------+
| Variable_name         | Value |
+-----------------------+-------+
| innodb_lru_scan_depth | 1024  |
+-----------------------+-------+

```

## doublewrite

```sql
mysql> show variables like '%doublewrite%'
    -> ;
+-------------------------------+-------+
| Variable_name                 | Value |
+-------------------------------+-------+
| innodb_doublewrite            | ON    |
| innodb_doublewrite_batch_size | 0     |
| innodb_doublewrite_dir        |       |
| innodb_doublewrite_files      | 2     |
| innodb_doublewrite_pages      | 8     |
+-------------------------------+-------+
5 rows in set (0.00 sec)
```


开启后有一定的性能损失5%-25%

**作用**
防止数据页写失败，写了一半redo log 也无法修复页。

**备注**
1. 当你的磁盘支持原子写，写入最小单位就是页的大小。
2. 文件系统ZFS 与 btrfs 才是copy_on_write的方式修改数据，相当于操作系统层面已经保证的，不会出现数据页写一半的情况。