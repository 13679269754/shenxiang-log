没问题！我们来搭建 **远程镜像仓库**（用于存储 Docker 镜像）和 **远程代码仓库**（用于 Git 代码管理），两者配合可实现“代码提交→自动构建镜像→K8s 部署”的完整流程。以下推荐两种低成本方案（适合个人/小团队），步骤简化且关键配置会详细说明。


### 一、方案选择：用开源工具搭建私有远程仓库（无需付费）
| 仓库类型       | 推荐工具               | 优势                                  | 部署方式               |
|----------------|------------------------|---------------------------------------|------------------------|
| 远程代码仓库   | Gitea（轻量级 Git 服务）| 兼容 Git 协议，支持 Web 界面，资源占用低 | Docker 容器部署（单节点） |
| 远程镜像仓库   | Harbor（企业级镜像仓库）| 支持镜像管理、权限控制、HTTPS，适合生产  | Docker Compose 部署     |


### 二、搭建远程代码仓库：Gitea（类似 GitHub 的私有 Git 服务）
#### 1. 部署 Gitea（用 Docker 快速启动）
```bash
# 创建数据目录（持久化代码仓库数据）
mkdir -p /opt/gitea/data /opt/gitea/config
chmod -R 777 /opt/gitea  # 给足权限（测试环境简化配置）

# 启动 Gitea 容器（端口 3000：Web 界面；222：SSH 访问）
docker run -d \
  --name gitea \
  -p 3000:3000 \
  -p 222:22 \
  -v /opt/gitea/data:/data \
  -v /etc/timezone:/etc/timezone:ro \
  -v /etc/localtime:/etc/localtime:ro \
  --restart always \
  gitea/gitea:1.21.5
```

#### 2. 初始化 Gitea（首次访问配置）
1. 访问 Web 界面：`http://你的服务器IP:3000`（如 `http://172.29.105.240:3000`）  
2. 首次登录会进入配置页，关键配置：  
   - **数据库类型**：选择 `SQLite3`（无需额外部署数据库，适合测试）  
   - **应用 URL**：填写 `http://你的服务器IP:3000`  
   - **SSH 服务器域名**：填写你的服务器 IP  
   - **SSH 端口**：保持 `22`（容器内端口，宿主机映射的是 222）  
1. 点击“安装 Gitea”，完成后注册管理员账号（如 `admin`，密码 `admin`）。

#### 3. 创建测试代码仓库
1. 登录 Gitea 后，点击右上角“+”→“新建仓库”  
2. 仓库名`simpe-api`，勾选“初：始化 RlEADME 文件”，点击“创建仓库”  
3. 仓库地址：  
   - HTTPS：`http://172.29.105.240:3000/admin/simple-api.git`  
   - SSH：`ssh://git@172.29.105.240:222/admin/simple-api.git`（注意端口是 222）  

[[git 常用]]

### 三、搭建远程镜像仓库：Harbor（企业级，支持权限和 HTTPS）
好的 👍，我来帮你把之前的步骤用你的 **IP: 172.29.105.240** 重新整理一份完整的操作指南。这样你可以直接照着做。

---

#### 🚀 Harbor 自签证书安装（IP: 172.29.105.240）并让 k8s 容器访问

#### 1️⃣ 生成自签 CA 和 Harbor 证书

##### 1. 生成 CA 根证书

```bash
openssl genrsa -out ca.key 4096
openssl req -x509 -new -nodes -key ca.key -sha256 -days 3650 \
  -out ca.crt -subj "/C=CN/ST=Shanghai/L=Shanghai/O=MyOrg/CN=Harbor-CA"
```

##### 2. 生成 Harbor 服务端证书请求

```bash
openssl genrsa -out harbor.key 4096
openssl req -new -key harbor.key -out harbor.csr \
  -subj "/C=CN/ST=Shanghai/L=Shanghai/O=MyOrg/CN=172.29.105.240"
```

##### 3. 使用 SAN 扩展签发证书（必须包含 IP）

```bash
cat > extfile.cnf <<EOF
subjectAltName = IP:172.29.105.240
extendedKeyUsage = serverAuth
EOF

openssl x509 -req -in harbor.csr -CA ca.crt -CAkey ca.key -CAcreateserial \
  -out harbor.crt -days 365 -sha256 -extfile extfile.cnf
```

生成的文件：

- `ca.crt`：根证书（要分发到 k8s 节点）
- `harbor.crt`：Harbor 服务端证书
- `harbor.key`：Harbor 私钥

---

#### 2️⃣ 配置 Harbor 使用证书

1. 将证书放到 Harbor 节点：
    
    ```bash
    mkdir -p /data/cert
    cp harbor.crt /data/cert/
    cp harbor.key /data/cert/
    ```
    
2. 修改 `harbor.yml`：
    
    ```yaml
    hostname: 172.29.105.240
    https:
      port: 443
      certificate: /data/cert/harbor.crt
      private_key: /data/cert/harbor.key
    ```
    
3. 重新安装 Harbor：
    
    ```bash
    ./install.sh --with-trivy
    ```
    

---

#### 3️⃣ 配置 Kubernetes 节点信任 Harbor 证书

##### 如果使用 **containerd**

```bash
mkdir -p /etc/containerd/certs.d/172.29.105.240
cp ca.crt /etc/containerd/certs.d/172.29.105.240/ca.crt
systemctl restart containerd
```

##### 如果使用 **docker**

```bash
mkdir -p /etc/docker/certs.d/172.29.105.240
cp ca.crt /etc/docker/certs.d/172.29.105.240/ca.crt
systemctl restart docker
```

---

#### 4️⃣ 验证节点能拉取镜像

```bash
crictl pull 172.29.105.240/library/nginx:latest
```

如果能成功拉取，说明证书和信任链配置正确。

---

#### 5️⃣ Pod 使用 Harbor 镜像

在 Deployment 或 Pod YAML 中直接写：

```yaml
containers:
- name: web
  image: 172.29.105.240/library/nginx:latest
```

---

#### 🔹 如果以后部署 Harbor 集群

- **推荐做法**：申请一个内部域名（如 `harbor.mycompany.local`），在 DNS 或 `/etc/hosts` 里解析到 VIP 或负载均衡地址。
- 证书里就写这个域名（SAN: `DNS:harbor.mycompany.local`），这样集群扩展时不用重新换证书。

---

### 四、关键操作：代码推送到 Gitea + 镜像推送到 Harbor

#### 1. 本地代码推送到 Gitea 远程仓库

bash

```bash
# 1. 克隆 Gitea 仓库到本地（替换为你的仓库地址）
git clone http://172.29.105.240:3000/admin/simple-api.git
cd simple-api

# 2. 将之前的 Spring Boot 项目文件复制到该目录
cp -r ../simple-api/* .  # 假设之前的项目在 ../simple-api

# 3. 提交并推送到远程
git add .
git commit -m "添加 Spring Boot 项目代码"
git push origin main  # 输入 Gitea 管理员账号密码（admin/admin123）
```

#### 2. 本地镜像推送到 Harbor 远程仓库

bash

```bash
# 1. 登录 Harbor（输入 admin/Harbor12345）
docker login 172.29.105.240
# 若提示“不安全的仓库”，需在本地 Docker 配置中添加（参考之前的“非安全仓库”配置）

# 2. 给镜像打标签（格式：Harbor地址/项目名/镜像名:版本）
docker tag simple-api:v1 172.29.105.240/simple-api/simple-api:v1

# 3. 推送到 Harbor
docker push 172.29.105.240/simple-api/simple-api:v1

# 4. 验证：在 Harbor 界面的“simple-api”项目中可看到推送的镜像
```

### 五、K8s 部署：从 Harbor 拉取镜像

修改 Deployment 配置中的 `image` 字段，指向 Harbor 仓库：

yaml

```yaml
spec:
  containers:
  - name: simple-api
    image: 172.29.105.240/simple-api/simple-api:v1  # Harbor 镜像地址
```

部署后，K8s 会从 Harbor 拉取镜像启动 Pod（确保所有 K8s 节点已配置信任 Harbor 仓库）。


### 六、核心注意事项
1. **远程仓库的“远程”含义**：  
   只要仓库部署在可通过网络访问的服务器上（即使是本地局域网的服务器），对其他机器而言就是“远程仓库”。若需要公网访问，需将服务器暴露在公网并配置域名/端口映射。

2. **权限控制**：  
   - Gitea 可创建多个用户，通过“组织”和“仓库权限”管理代码访问（如开发者只能拉取，管理员可推送）。  
   - Harbor 可通过“项目成员”配置镜像推送/拉取权限（生产环境建议设为私有，避免镜像泄露）。

3. **HTTPS 配置**：  
   测试环境可禁用 HTTPS，但生产环境必须配置 SSL 证书（Gitea 和 Harbor 都支持 Let's Encrypt 免费证书），否则数据传输不安全。

4. **数据备份**：  
   - Gitea 数据在 `/opt/gitea/data`，定期备份该目录即可。  
   - Harbor 数据在 `/opt/harbor/data`，包含镜像和数据库，需定期备份。


通过以上步骤，你已拥有完整的“远程代码仓库（Gitea）+ 远程镜像仓库（Harbor）”，后续可结合 CI/CD 工具（如 Jenkins）实现“代码提交后自动构建镜像并推送到 Harbor，再更新 K8s 部署”的自动化流程，进一步提升效率。


### 七、问题处理
我k8s的环境如下
```
[root@k8s-172-29-105-243 containerd]# crictl version
Version:  0.1.0
RuntimeName:  containerd
RuntimeVersion:  v2.1.1
RuntimeApiVersion:  v1

```

**证书问题排查**
[[harbor 访问权限问题排查]]


**系统信任库**
   - 有些发行版的 containerd 还会依赖系统 CA 库。保险起见，把 `ca.crt` 也放到系统信任目录：
     ```bash
     cp ca.crt /etc/pki/ca-trust/source/anchors/
     update-ca-trust
     ```
     或者在 Debian/Ubuntu：
     ```bash
     cp ca.crt /usr/local/share/ca-certificates/harbor-ca.crt
     update-ca-certificates
     ```