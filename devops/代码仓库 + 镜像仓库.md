æ²¡é—®é¢˜ï¼æˆ‘ä»¬æ¥æ­å»º **è¿œç¨‹é•œåƒä»“åº“**ï¼ˆç”¨äºŽå­˜å‚¨ Docker é•œåƒï¼‰å’Œ **è¿œç¨‹ä»£ç ä»“åº“**ï¼ˆç”¨äºŽ Git ä»£ç ç®¡ç†ï¼‰ï¼Œä¸¤è€…é…åˆå¯å®žçŽ°â€œä»£ç æäº¤â†’è‡ªåŠ¨æž„å»ºé•œåƒâ†’K8s éƒ¨ç½²â€çš„å®Œæ•´æµç¨‹ã€‚ä»¥ä¸‹æŽ¨èä¸¤ç§ä½Žæˆæœ¬æ–¹æ¡ˆï¼ˆé€‚åˆä¸ªäºº/å°å›¢é˜Ÿï¼‰ï¼Œæ­¥éª¤ç®€åŒ–ä¸”å…³é”®é…ç½®ä¼šè¯¦ç»†è¯´æ˜Žã€‚


### ä¸€ã€æ–¹æ¡ˆé€‰æ‹©ï¼šç”¨å¼€æºå·¥å…·æ­å»ºç§æœ‰è¿œç¨‹ä»“åº“ï¼ˆæ— éœ€ä»˜è´¹ï¼‰
| ä»“åº“ç±»åž‹       | æŽ¨èå·¥å…·               | ä¼˜åŠ¿                                  | éƒ¨ç½²æ–¹å¼               |
|----------------|------------------------|---------------------------------------|------------------------|
| è¿œç¨‹ä»£ç ä»“åº“   | Giteaï¼ˆè½»é‡çº§ Git æœåŠ¡ï¼‰| å…¼å®¹ Git åè®®ï¼Œæ”¯æŒ Web ç•Œé¢ï¼Œèµ„æºå ç”¨ä½Ž | Docker å®¹å™¨éƒ¨ç½²ï¼ˆå•èŠ‚ç‚¹ï¼‰ |
| è¿œç¨‹é•œåƒä»“åº“   | Harborï¼ˆä¼ä¸šçº§é•œåƒä»“åº“ï¼‰| æ”¯æŒé•œåƒç®¡ç†ã€æƒé™æŽ§åˆ¶ã€HTTPSï¼Œé€‚åˆç”Ÿäº§  | Docker Compose éƒ¨ç½²     |


### äºŒã€æ­å»ºè¿œç¨‹ä»£ç ä»“åº“ï¼šGiteaï¼ˆç±»ä¼¼ GitHub çš„ç§æœ‰ Git æœåŠ¡ï¼‰
#### 1. éƒ¨ç½² Giteaï¼ˆç”¨ Docker å¿«é€Ÿå¯åŠ¨ï¼‰
```bash
# åˆ›å»ºæ•°æ®ç›®å½•ï¼ˆæŒä¹…åŒ–ä»£ç ä»“åº“æ•°æ®ï¼‰
mkdir -p /opt/gitea/data /opt/gitea/config
chmod -R 777 /opt/gitea  # ç»™è¶³æƒé™ï¼ˆæµ‹è¯•çŽ¯å¢ƒç®€åŒ–é…ç½®ï¼‰

# å¯åŠ¨ Gitea å®¹å™¨ï¼ˆç«¯å£ 3000ï¼šWeb ç•Œé¢ï¼›222ï¼šSSH è®¿é—®ï¼‰
docker run -d \
  --name gitea \
  -p 3000:3000 \
  -p 222:22 \
  -v /opt/gitea/data:/data \
  -v /etc/timezone:/etc/timezone:ro \
  -v /etc/localtime:/etc/localtime:ro \
  --restart always \
  gitea/gitea:1.21.5
```

#### 2. åˆå§‹åŒ– Giteaï¼ˆé¦–æ¬¡è®¿é—®é…ç½®ï¼‰
1. è®¿é—® Web ç•Œé¢ï¼š`http://ä½ çš„æœåŠ¡å™¨IP:3000`ï¼ˆå¦‚ `http://172.29.105.240:3000`ï¼‰  
2. é¦–æ¬¡ç™»å½•ä¼šè¿›å…¥é…ç½®é¡µï¼Œå…³é”®é…ç½®ï¼š  
   - **æ•°æ®åº“ç±»åž‹**ï¼šé€‰æ‹© `SQLite3`ï¼ˆæ— éœ€é¢å¤–éƒ¨ç½²æ•°æ®åº“ï¼Œé€‚åˆæµ‹è¯•ï¼‰  
   - **åº”ç”¨ URL**ï¼šå¡«å†™ `http://ä½ çš„æœåŠ¡å™¨IP:3000`  
   - **SSH æœåŠ¡å™¨åŸŸå**ï¼šå¡«å†™ä½ çš„æœåŠ¡å™¨ IP  
   - **SSH ç«¯å£**ï¼šä¿æŒ `22`ï¼ˆå®¹å™¨å†…ç«¯å£ï¼Œå®¿ä¸»æœºæ˜ å°„çš„æ˜¯ 222ï¼‰  
1. ç‚¹å‡»â€œå®‰è£… Giteaâ€ï¼Œå®ŒæˆåŽæ³¨å†Œç®¡ç†å‘˜è´¦å·ï¼ˆå¦‚ `admin`ï¼Œå¯†ç  `admin`ï¼‰ã€‚

#### 3. åˆ›å»ºæµ‹è¯•ä»£ç ä»“åº“
1. ç™»å½• Gitea åŽï¼Œç‚¹å‡»å³ä¸Šè§’â€œ+â€â†’â€œæ–°å»ºä»“åº“â€  
2. ä»“åº“å`simpe-api`ï¼Œå‹¾é€‰â€œåˆï¼šå§‹åŒ– RlEADME æ–‡ä»¶â€ï¼Œç‚¹å‡»â€œåˆ›å»ºä»“åº“â€  
3. ä»“åº“åœ°å€ï¼š  
   - HTTPSï¼š`http://172.29.105.240:3000/admin/simple-api.git`  
   - SSHï¼š`ssh://git@172.29.105.240:222/admin/simple-api.git`ï¼ˆæ³¨æ„ç«¯å£æ˜¯ 222ï¼‰  

[[git å¸¸ç”¨]]

### ä¸‰ã€æ­å»ºè¿œç¨‹é•œåƒä»“åº“ï¼šHarborï¼ˆä¼ä¸šçº§ï¼Œæ”¯æŒæƒé™å’Œ HTTPSï¼‰
å¥½çš„ ðŸ‘ï¼Œæˆ‘æ¥å¸®ä½ æŠŠä¹‹å‰çš„æ­¥éª¤ç”¨ä½ çš„ **IP: 172.29.105.240** é‡æ–°æ•´ç†ä¸€ä»½å®Œæ•´çš„æ“ä½œæŒ‡å—ã€‚è¿™æ ·ä½ å¯ä»¥ç›´æŽ¥ç…§ç€åšã€‚

---

#### ðŸš€ Harbor è‡ªç­¾è¯ä¹¦å®‰è£…ï¼ˆIP: 172.29.105.240ï¼‰å¹¶è®© k8s å®¹å™¨è®¿é—®

#### 1ï¸âƒ£ ç”Ÿæˆè‡ªç­¾ CA å’Œ Harbor è¯ä¹¦

##### 1. ç”Ÿæˆ CA æ ¹è¯ä¹¦

```bash
openssl genrsa -out ca.key 4096
openssl req -x509 -new -nodes -key ca.key -sha256 -days 3650 \
  -out ca.crt -subj "/C=CN/ST=Shanghai/L=Shanghai/O=MyOrg/CN=Harbor-CA"
```

##### 2. ç”Ÿæˆ Harbor æœåŠ¡ç«¯è¯ä¹¦è¯·æ±‚

```bash
openssl genrsa -out harbor.key 4096
openssl req -new -key harbor.key -out harbor.csr \
  -subj "/C=CN/ST=Shanghai/L=Shanghai/O=MyOrg/CN=172.29.105.240"
```

##### 3. ä½¿ç”¨ SAN æ‰©å±•ç­¾å‘è¯ä¹¦ï¼ˆå¿…é¡»åŒ…å« IPï¼‰

```bash
cat > extfile.cnf <<EOF
subjectAltName = IP:172.29.105.240
extendedKeyUsage = serverAuth
EOF

openssl x509 -req -in harbor.csr -CA ca.crt -CAkey ca.key -CAcreateserial \
  -out harbor.crt -days 365 -sha256 -extfile extfile.cnf
```

ç”Ÿæˆçš„æ–‡ä»¶ï¼š

- `ca.crt`ï¼šæ ¹è¯ä¹¦ï¼ˆè¦åˆ†å‘åˆ° k8s èŠ‚ç‚¹ï¼‰
- `harbor.crt`ï¼šHarbor æœåŠ¡ç«¯è¯ä¹¦
- `harbor.key`ï¼šHarbor ç§é’¥

---

#### 2ï¸âƒ£ é…ç½® Harbor ä½¿ç”¨è¯ä¹¦

1. å°†è¯ä¹¦æ”¾åˆ° Harbor èŠ‚ç‚¹ï¼š
    
    ```bash
    mkdir -p /data/cert
    cp harbor.crt /data/cert/
    cp harbor.key /data/cert/
    ```
    
2. ä¿®æ”¹ `harbor.yml`ï¼š
    
    ```yaml
    hostname: 172.29.105.240
    https:
      port: 443
      certificate: /data/cert/harbor.crt
      private_key: /data/cert/harbor.key
    ```
    
3. é‡æ–°å®‰è£… Harborï¼š
    
    ```bash
    ./install.sh --with-trivy
    ```
    

---

#### 3ï¸âƒ£ é…ç½® Kubernetes èŠ‚ç‚¹ä¿¡ä»» Harbor è¯ä¹¦

##### å¦‚æžœä½¿ç”¨ **containerd**

```bash
mkdir -p /etc/containerd/certs.d/172.29.105.240
cp ca.crt /etc/containerd/certs.d/172.29.105.240/ca.crt
systemctl restart containerd
```

##### å¦‚æžœä½¿ç”¨ **docker**

```bash
mkdir -p /etc/docker/certs.d/172.29.105.240
cp ca.crt /etc/docker/certs.d/172.29.105.240/ca.crt
systemctl restart docker
```

---

#### 4ï¸âƒ£ éªŒè¯èŠ‚ç‚¹èƒ½æ‹‰å–é•œåƒ

```bash
crictl pull 172.29.105.240/library/nginx:latest
```

å¦‚æžœèƒ½æˆåŠŸæ‹‰å–ï¼Œè¯´æ˜Žè¯ä¹¦å’Œä¿¡ä»»é“¾é…ç½®æ­£ç¡®ã€‚

---

#### 5ï¸âƒ£ Pod ä½¿ç”¨ Harbor é•œåƒ

åœ¨ Deployment æˆ– Pod YAML ä¸­ç›´æŽ¥å†™ï¼š

```yaml
containers:
- name: web
  image: 172.29.105.240/library/nginx:latest
```

---

#### ðŸ”¹ å¦‚æžœä»¥åŽéƒ¨ç½² Harbor é›†ç¾¤

- **æŽ¨èåšæ³•**ï¼šç”³è¯·ä¸€ä¸ªå†…éƒ¨åŸŸåï¼ˆå¦‚ `harbor.mycompany.local`ï¼‰ï¼Œåœ¨ DNS æˆ– `/etc/hosts` é‡Œè§£æžåˆ° VIP æˆ–è´Ÿè½½å‡è¡¡åœ°å€ã€‚
- è¯ä¹¦é‡Œå°±å†™è¿™ä¸ªåŸŸåï¼ˆSAN: `DNS:harbor.mycompany.local`ï¼‰ï¼Œè¿™æ ·é›†ç¾¤æ‰©å±•æ—¶ä¸ç”¨é‡æ–°æ¢è¯ä¹¦ã€‚

---

### å››ã€å…³é”®æ“ä½œï¼šä»£ç æŽ¨é€åˆ° Gitea + é•œåƒæŽ¨é€åˆ° Harbor

#### 1. æœ¬åœ°ä»£ç æŽ¨é€åˆ° Gitea è¿œç¨‹ä»“åº“

bash

```bash
# 1. å…‹éš† Gitea ä»“åº“åˆ°æœ¬åœ°ï¼ˆæ›¿æ¢ä¸ºä½ çš„ä»“åº“åœ°å€ï¼‰
git clone http://172.29.105.240:3000/admin/simple-api.git
cd simple-api

# 2. å°†ä¹‹å‰çš„ Spring Boot é¡¹ç›®æ–‡ä»¶å¤åˆ¶åˆ°è¯¥ç›®å½•
cp -r ../simple-api/* .  # å‡è®¾ä¹‹å‰çš„é¡¹ç›®åœ¨ ../simple-api

# 3. æäº¤å¹¶æŽ¨é€åˆ°è¿œç¨‹
git add .
git commit -m "æ·»åŠ  Spring Boot é¡¹ç›®ä»£ç "
git push origin main  # è¾“å…¥ Gitea ç®¡ç†å‘˜è´¦å·å¯†ç ï¼ˆadmin/admin123ï¼‰
```

#### 2. æœ¬åœ°é•œåƒæŽ¨é€åˆ° Harbor è¿œç¨‹ä»“åº“

bash

```bash
# 1. ç™»å½• Harborï¼ˆè¾“å…¥ admin/Harbor12345ï¼‰
docker login 172.29.105.240
# è‹¥æç¤ºâ€œä¸å®‰å…¨çš„ä»“åº“â€ï¼Œéœ€åœ¨æœ¬åœ° Docker é…ç½®ä¸­æ·»åŠ ï¼ˆå‚è€ƒä¹‹å‰çš„â€œéžå®‰å…¨ä»“åº“â€é…ç½®ï¼‰

# 2. ç»™é•œåƒæ‰“æ ‡ç­¾ï¼ˆæ ¼å¼ï¼šHarboråœ°å€/é¡¹ç›®å/é•œåƒå:ç‰ˆæœ¬ï¼‰
docker tag simple-api:v1 172.29.105.240/simple-api/simple-api:v1

# 3. æŽ¨é€åˆ° Harbor
docker push 172.29.105.240/simple-api/simple-api:v1

# 4. éªŒè¯ï¼šåœ¨ Harbor ç•Œé¢çš„â€œsimple-apiâ€é¡¹ç›®ä¸­å¯çœ‹åˆ°æŽ¨é€çš„é•œåƒ
```

### äº”ã€K8s éƒ¨ç½²ï¼šä»Ž Harbor æ‹‰å–é•œåƒ

ä¿®æ”¹ Deployment é…ç½®ä¸­çš„Â `image`Â å­—æ®µï¼ŒæŒ‡å‘ Harbor ä»“åº“ï¼š

yaml

```yaml
spec:
  containers:
  - name: simple-api
    image: 172.29.105.240/simple-api/simple-api:v1  # Harbor é•œåƒåœ°å€
```

éƒ¨ç½²åŽï¼ŒK8s ä¼šä»Ž Harbor æ‹‰å–é•œåƒå¯åŠ¨ Podï¼ˆç¡®ä¿æ‰€æœ‰ K8s èŠ‚ç‚¹å·²é…ç½®ä¿¡ä»» Harbor ä»“åº“ï¼‰ã€‚


### å…­ã€æ ¸å¿ƒæ³¨æ„äº‹é¡¹
1. **è¿œç¨‹ä»“åº“çš„â€œè¿œç¨‹â€å«ä¹‰**ï¼š  
   åªè¦ä»“åº“éƒ¨ç½²åœ¨å¯é€šè¿‡ç½‘ç»œè®¿é—®çš„æœåŠ¡å™¨ä¸Šï¼ˆå³ä½¿æ˜¯æœ¬åœ°å±€åŸŸç½‘çš„æœåŠ¡å™¨ï¼‰ï¼Œå¯¹å…¶ä»–æœºå™¨è€Œè¨€å°±æ˜¯â€œè¿œç¨‹ä»“åº“â€ã€‚è‹¥éœ€è¦å…¬ç½‘è®¿é—®ï¼Œéœ€å°†æœåŠ¡å™¨æš´éœ²åœ¨å…¬ç½‘å¹¶é…ç½®åŸŸå/ç«¯å£æ˜ å°„ã€‚

2. **æƒé™æŽ§åˆ¶**ï¼š  
   - Gitea å¯åˆ›å»ºå¤šä¸ªç”¨æˆ·ï¼Œé€šè¿‡â€œç»„ç»‡â€å’Œâ€œä»“åº“æƒé™â€ç®¡ç†ä»£ç è®¿é—®ï¼ˆå¦‚å¼€å‘è€…åªèƒ½æ‹‰å–ï¼Œç®¡ç†å‘˜å¯æŽ¨é€ï¼‰ã€‚  
   - Harbor å¯é€šè¿‡â€œé¡¹ç›®æˆå‘˜â€é…ç½®é•œåƒæŽ¨é€/æ‹‰å–æƒé™ï¼ˆç”Ÿäº§çŽ¯å¢ƒå»ºè®®è®¾ä¸ºç§æœ‰ï¼Œé¿å…é•œåƒæ³„éœ²ï¼‰ã€‚

3. **HTTPS é…ç½®**ï¼š  
   æµ‹è¯•çŽ¯å¢ƒå¯ç¦ç”¨ HTTPSï¼Œä½†ç”Ÿäº§çŽ¯å¢ƒå¿…é¡»é…ç½® SSL è¯ä¹¦ï¼ˆGitea å’Œ Harbor éƒ½æ”¯æŒ Let's Encrypt å…è´¹è¯ä¹¦ï¼‰ï¼Œå¦åˆ™æ•°æ®ä¼ è¾“ä¸å®‰å…¨ã€‚

4. **æ•°æ®å¤‡ä»½**ï¼š  
   - Gitea æ•°æ®åœ¨ `/opt/gitea/data`ï¼Œå®šæœŸå¤‡ä»½è¯¥ç›®å½•å³å¯ã€‚  
   - Harbor æ•°æ®åœ¨ `/opt/harbor/data`ï¼ŒåŒ…å«é•œåƒå’Œæ•°æ®åº“ï¼Œéœ€å®šæœŸå¤‡ä»½ã€‚


é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œä½ å·²æ‹¥æœ‰å®Œæ•´çš„â€œè¿œç¨‹ä»£ç ä»“åº“ï¼ˆGiteaï¼‰+ è¿œç¨‹é•œåƒä»“åº“ï¼ˆHarborï¼‰â€ï¼ŒåŽç»­å¯ç»“åˆ CI/CD å·¥å…·ï¼ˆå¦‚ Jenkinsï¼‰å®žçŽ°â€œä»£ç æäº¤åŽè‡ªåŠ¨æž„å»ºé•œåƒå¹¶æŽ¨é€åˆ° Harborï¼Œå†æ›´æ–° K8s éƒ¨ç½²â€çš„è‡ªåŠ¨åŒ–æµç¨‹ï¼Œè¿›ä¸€æ­¥æå‡æ•ˆçŽ‡ã€‚


### ä¸ƒã€é—®é¢˜å¤„ç†
æˆ‘k8sçš„çŽ¯å¢ƒå¦‚ä¸‹
```
[root@k8s-172-29-105-243 containerd]# crictl version
Version:  0.1.0
RuntimeName:  containerd
RuntimeVersion:  v2.1.1
RuntimeApiVersion:  v1

```

**è¯ä¹¦é—®é¢˜æŽ’æŸ¥**
[[harbor è®¿é—®æƒé™é—®é¢˜æŽ’æŸ¥]]


**ç³»ç»Ÿä¿¡ä»»åº“**
   - æœ‰äº›å‘è¡Œç‰ˆçš„ containerd è¿˜ä¼šä¾èµ–ç³»ç»Ÿ CA åº“ã€‚ä¿é™©èµ·è§ï¼ŒæŠŠ `ca.crt` ä¹Ÿæ”¾åˆ°ç³»ç»Ÿä¿¡ä»»ç›®å½•ï¼š
     ```bash
     cp ca.crt /etc/pki/ca-trust/source/anchors/
     update-ca-trust
     ```
     æˆ–è€…åœ¨ Debian/Ubuntuï¼š
     ```bash
     cp ca.crt /usr/local/share/ca-certificates/harbor-ca.crt
     update-ca-certificates
     ```