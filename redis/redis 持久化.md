| operator | createtime | updatetime |
| ---- | ---- | ---- |
| shenx | 2024-10月-19 | 2024-10月-19  |
| ... | ... | ... |
---
# redis 持久化

[toc]

## 源文档

[全面解析 Redis 持久化：RDB、AOF与混合持久化](https://segmentfault.com/a/1190000044652257)

## RDB重要内容提取

### RDB配置
rdb 重要配置

```bash
redis 配置文件 save 指令设置： 
save 3600 1        # 3600秒内如果超过1个key被修改则生成 RDB
save 300 100       # 300秒内如果超过100个key被修改则生成 RDB
save 60 10000      # 60秒内如果超过10000个key被修改则生成 RDB
stop-writes-on-bgsave-error
rdbcompression
rdbchecksum
sanitize-dump-payload
dbfilename
rdb-del-sync-files
dir
```

### RDB 持久化的优缺点
**优点**
> 快速备份：RDB可以迅速为你创建一个数据的“快照”，这是一个备份文件，方便你存储或者迁移数据。

> 启动快：当Redis重新启动时，RDB能帮助它更快速地加载数据，因为它直接读取一个完整的数据文件。

> 节省空间：与其他持久化方式相比，RDB的文件大小通常较小，因为它是经过压缩的。

**缺点**
> 可能丢数据：因为RDB只是不时地保存一次数据快照，如果在两次保存之间Redis出了问题，那中间的数据就可能会丢失。

> **有时会卡**：在数据很多的情况下，创建 RDB 文件时可能会使服务器短暂地感觉有些卡顿。


## AOF重要内容提取

### AOF过程

AOF 持久化的实现主要是以上三步：命令追加、文件写入、文件同步

1. 命令追加: 将 redis 写操作命令追加到 aof_buf 缓冲区
2. 文件写入: 周期性地将 aof_buf 缓冲区的命令写入 AOF 文件的内核缓冲区。
3. 文件同步:根据配置同步策略，将 AOF 文件缓冲区的内容同步到磁盘。

其中文件同步策略 redis 提供了三种，分别是以下三种：

>**always**：每次有命令写入时都立即同步。这提供了最高的数据安全性，但效率最低。
**everysec**：每秒同步一次。这是一个权衡安全性和效率的策略。最多只丢失 1 秒 的数据
**no**：让操作系统决定最佳的同步时间。这可能导致数据丢失，但提供了最高的效率。


### AOF 重写
AOF 重写主要有以下四步：

1. redis 主进程 fork 子进程来进行 AOF 的重写，生成 AOF 文件。
2. 在子进程进行 AOF 重写的同时，redis 主进程将新的写操作命令写入 AOF重写缓冲区
3. 主进程将 AOF 重写缓冲区的内容写入到新的 AOF 文件中
4. 使用新的 AOF 文件替换旧的 AOF 文件

这里思考一下：子进程 进行 AOF 重写，具体怎么重写，是根据现有的 AOF 文件进行重写还是其他方式？

**子进程是通过读取 Redis 当前的内存数据来进行重写的。**

### 怎样自动触发 AOF 文件重写？

A: 使用以下两个配置：

`auto-aof-rewrite-percentage`: AOF 文件增长的百分比，达到此值则触发 AOF 重写。例如，如果设置为100%，那么当 AOF 文件的大小是上次重写后的两倍时，Redis 会考虑触发自动重写。

`auto-aof-rewrite-min-size`: AOF 文件大小门槛，超过此值即使增长的百分比小也会触发 AOF 重写。

### 如果 AOF 文件在末尾被截断，Redis怎么办？

A: 使用 aof-load-truncated 选项。如果设置为 yes，Redis 尝试加载并启动，同时发出日志警告；如果为 no，Redis 会中止并拒绝启动。默认是 yes。

### 假如 Redis 的 RDB 和 AOF 持久化都启用，redis 在载入数据的时候，是载入 AOF 文件？还是 RDB 文件？

> 我直接说答案：Redis 会优先载入 AOF 文件来恢复数据，而不是 RDB 文件。这是因为 AOF 文件通常包含了更完整的操作记录，从而能够恢复更完整的数据状态。而 RDB 文件是定时生成的数据快照，所以它可能没有记录到最后一次快照之后发生的所有更改。因此，使用 AOF 文件恢复数据可以提供更高的数据完整性。 

## 混合持久化的配置

Q: Redis 的混合持久化如何开启？

A: 将 `aof-use-rdb-preamble` 选项设置为 yes，并且要同时启用 RDB 和 AOF 两种持久化。

**混合持久化的 AOF 重写与普通的 AOF 重写的区别：**

在不使用混合持久化的情况下，普通的 AOF 重写是通过读取当前的内存数据并记录达到这一状态所需的最少命令来减少 AOF 文件的大小的。

**而混合持久化在 AOF 重写时，会首先将当前数据集以 RDB 格式快照的形式写入新 AOF 文件的开始位置，然后再追加新的写命令到文件末尾。**
